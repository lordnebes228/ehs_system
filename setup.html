<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã - –°–°–ö</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 40px; }
        .setup-card { background: white; max-width: 600px; margin: 0 auto; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        input, select, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; }
        .back-link { display: block; text-align: center; margin-top: 20px; color: #3498db; text-decoration: none; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #1a252f; }
    </style>
</head>
<body>

<div class="setup-card">
    <h2>üõ† –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</h2>
    <p>–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —Ü–µ—Ö –∏–ª–∏ –æ—Ç–¥–µ–ª –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã:</p>
    
    <input type="text" id="deptName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –¶–µ—Ö ‚Ññ5, –û—Ç–¥–µ–ª –ü–ë)">
    <select id="deptType">
        <option value="–¶–µ—Ö">–¢–∏–ø: –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –¶–µ—Ö</option>
        <option value="–û—Ç–¥–µ–ª">–¢–∏–ø: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –û—Ç–¥–µ–ª</option>
    </select>
    <button onclick="saveDept()">–°–û–•–†–ê–ù–ò–¢–¨ –í –ë–ê–ó–£</button>

    <h2 style="margin-top:40px;">üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
    <input type="text" id="regLogin" placeholder="–õ–æ–≥–∏–Ω (ivanov)">
    <input type="password" id="regPass" placeholder="–ü–∞—Ä–æ–ª—å">
    <select id="regRole">
        <option value="–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å">–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
        <option value="–ù–∞—á–∞–ª—å–Ω–∏–∫ —Ü–µ—Ö–∞">–ù–∞—á–∞–ª—å–Ω–∏–∫ —Ü–µ—Ö–∞</option>
        <option value="–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä">–ò–Ω—Å–ø–µ–∫—Ç–æ—Ä</option>
        <option value="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
    </select>
    <select id="targetDept"></select>
    <button onclick="registerUser()" style="background: #3498db;">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>

    <a href="index.html" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∂—É—Ä–Ω–∞–ª—É –∞–∫—Ç–æ–≤</a>
</div>

<script>
    const SUPABASE_URL = 'https://znlizfcqmxgrnhimzgul.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_RacKEAEQhObo56gGr8BYnA_numHTBIj';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ü–µ—Ö–æ–≤ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
    async function loadDepts() {
        const { data } = await _supabase.from('departments').select('*').order('name');
        const select = document.getElementById('targetDept');
        select.innerHTML = data.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ü–µ—Ö–∞
    async function saveDept() {
        const name = document.getElementById('deptName').value.trim();
        const type = document.getElementById('deptType').value;
        if(!name) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");

        const { error } = await _supabase.from('departments').insert([{ name, type }]);
        if(error) alert("–û—à–∏–±–∫–∞: " + error.message);
        else {
            alert("–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!");
            document.getElementById('deptName').value = '';
            loadDepts();
        }
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    async function registerUser() {
        const login = document.getElementById('regLogin').value.trim();
        const pass = document.getElementById('regPass').value;
        const dept = document.getElementById('targetDept').value;
        const role = document.getElementById('regRole').value;

        const { data, error } = await _supabase.auth.signUp({ email: login + "@ssk.local", password: pass });
        if (error) return alert(error.message);

        await _supabase.from('profiles').insert([{ 
            id: data.user.id, 
            username: login, 
            role: role, 
            department: dept,
            can_manage_users: (role === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'),
            can_use_mobile: true 
        }]);
        alert("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!");
    }

    loadDepts();
</script>
</body>
</html>